- name: Prepare random number
  set_fact:
    rpfx: "{{ resource_group | hash('md5') | truncate(7, True, '') }}{{ 1000 | random }}"
  run_once: yes

- name: Create security group -- using module
  azure_rm_securitygroup:
    resource_group: "{{ resource_group }}"
    name: sg{{ rpfx }}
    purge_rules: yes
    rules:
      - name: DenySSH
        protocol: Tcp
        destination_port_range: 22
        access: Deny
        priority: 100
        direction: Inbound
      - name: AllowSSH
        protocol: Tcp
        source_address_prefix: 174.109.158.0/24
        destination_port_range: 22
        access: Allow
        priority: 101
        direction: Inbound

- name: Create security rule
  azure_rm_resource:
    resource_group: "{{ resource_group }}"
    provider: network
    resource_type: networksecuritygroups
    resource_name: sg{{ rpfx }}
    subresource:
      - type: securityrules
        name: mysecurityrule
    api_version: "2018-01-01"
    body:
      properties:
        protocol: "*"
        sourceAddressPrefix: "10.0.0.0/8"
        destinationAddressPrefix: "11.0.0.0/8"
        access: "Deny"
        destinationPortRange: "8080"
        sourcePortRange: "*"
        priority: 100
        direction: "Outbound"

- name: Query instance of security rule
    resource_group: "{{ resource_group }}"
    provider: network
    resource_type: networksecuritygroups
    resource_name: sg{{ rpfx }}
    subresource:
      - type: securityrules
        name: mysecurityrule
    api_version: "2018-01-01"

- name: Create instance of resource
  azure_rm_resource:
    resource_group: "{{ resource_group }}"
    provider: batch
    resource_type: batchaccounts
    resource_name: batch{{ rpfx }}
    api_version: "2017-09-01"
    body:
      location: eastus

- name: Query instance of resource
  azure_rm_resource_facts:
    resource_group: "{{ resource_group }}"
    provider: batch
    resource_type: batchaccounts
    resource_name: batch{{ rpfx }}
    api_version: "2017-09-01"
